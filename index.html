<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·å¯†ç ç®¡ç†å™¨ V4.1 (äº‘ç«¯åŒæ­¥å¢å¼ºç‰ˆ)</title>
    <link rel="icon" href="images/book.png" type="image/x-icon">
    <script src="./mincloud.js"></script>
    <style>
        /* ===== æ ¸å¿ƒæ ·å¼åŸºç¡€ ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 50%, #f0f4c3 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* ===== é¡¶éƒ¨æ å¸ƒå±€ä¼˜åŒ– ===== */
        .header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            margin-bottom: 30px;
            color: #2e7d32;
        }
        .header h1 {
            font-size: 2.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            margin-right: 40px;
        }

        .time-search-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .clock-container {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.8);
        }
        .time-display {
            font-size: 1.6rem;
            font-weight: bold;
            color: #2e7d32;
            font-family: 'Courier New', monospace;
        }
        .date-display { font-size: 0.9rem; color: #388e3c; }

        /* æœç´¢æ¡† */
        .search-container { position: relative; display: flex; align-items: center; }
        .search-input {
            padding: 6px 35px;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            width: 200px;
            height: 38px;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
        }
        .search-input:focus { outline: none; border-color: #4caf50; width: 240px; background: #fff; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 16px; opacity: 0.6; }
        .clear-button {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: #ff6b6b; color: #fff; border: none; cursor: pointer;
            width: 18px; height: 18px; border-radius: 50%; display: none; align-items: center; justify-content: center;
        }

        /* æŒ‰é’®ä½ç½®å‘å·¦è°ƒæ•´ (é€šè¿‡ margin-right) */
        .header-actions { padding-right: 120px; } 
        .btn-add {
            background: #2e7d32; color: white; border: none; padding: 10px 20px;
            border-radius: 10px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s;
        }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

        /* ===== åˆ—è¡¨ä¸å¡ç‰‡ ===== */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }
        .account-card {
            background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08); transition: all 0.3s ease;
            position: relative; border: 1px solid rgba(255,255,255,0.5); cursor: move;
        }
        .account-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
        .account-card.dim { opacity: 0.2; filter: grayscale(80%); pointer-events: none; }
        .account-card.hit { box-shadow: 0 0 0 2px #4caf50; }

        .system-name {
            font-size: 1.1rem; font-weight: bold; color: #2e7d32;
            padding: 0 35px 8px 5px; border-bottom: 2px solid #c8e6c9; margin-bottom: 10px;
        }

        .item-value {
            background: #f1f8e9; border: 1px solid #c8e6c9; border-radius: 8px;
            padding: 6px 10px; cursor: pointer; margin-top: 5px; position: relative;
            font-family: 'Courier New', monospace; transition: all 0.2s;
        }
        .item-value:hover { background: #e8f5e8; border-color: #4caf50; }
        
        /* æœç´¢é«˜äº®æ ·å¼ */
        .highlight { background-color: #ffeb3b; border-radius: 2px; padding: 0 2px; color: #000; font-weight: bold; }

        /* é“¾æ¥å›¾æ ‡ */
        .link-icon {
            position: absolute; right: 35px; top: 12px; cursor: pointer; opacity: 0.5; transition: 0.2s;
        }
        .link-icon:hover { opacity: 1; transform: scale(1.2); }

        /* ===== ç¾åŒ–åˆ é™¤æŒ‰é’® ===== */
        .delete-btn {
            position: absolute; bottom: 10px; right: 10px;
            width: 28px; height: 28px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            color: #ef5350; background: rgba(239, 83, 80, 0.1);
            cursor: pointer; opacity: 0; transition: all 0.2s;
        }
        .account-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { background: #ef5350; color: white; transform: rotate(10deg); }

        /* ===== æ‚¬æµ®æç¤ºæ¡† (Tooltip) ===== */
        .url-tooltip {
            position: fixed; background: #333; color: #fff; padding: 6px 12px;
            border-radius: 6px; font-size: 12px; z-index: 10000; pointer-events: none;
            opacity: 0; transition: opacity 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            max-width: 300px; word-break: break-all;
        }
        .url-tooltip.show { opacity: 1; }

        /* ===== å¼¹çª—æ ·å¼ ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 20000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 15px; width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: #666; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #4caf50; color: white; padding: 10px 25px; border-radius: 25px;
            z-index: 30000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body ondragover="event.preventDefault()">

<div class="container">
    <div class="header">
        <h1>ğŸ” è´¦å·ç®¡ç†å™¨</h1>
        <div class="time-search-container">
            <div class="clock-container">
                <div class="time-display" id="timeDisplay">00:00:00</div>
                <div class="date-display" id="solarDate">----å¹´--æœˆ--æ—¥</div>
            </div>
            <div class="search-container">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232e7d32'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E" class="search-icon">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ç³»ç»Ÿæˆ–è´¦å·...">
                <button class="clear-button" id="clearButton">âœ•</button>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-add" onclick="openModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                æ–°å¢è´¦å·
            </button>
        </div>
    </div>

    <div class="accounts-grid" id="accountsGrid">
        </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <h3 style="margin-bottom:20px; color:#2e7d32">æ–°å¢è´¦å·ä¿¡æ¯</h3>
        <div class="form-group">
            <label>ç³»ç»Ÿåç§°</label>
            <input type="text" id="formSystem" placeholder="ä¾‹å¦‚ï¼šé˜¿é‡Œäº‘">
        </div>
        <div class="form-group">
            <label>è®¿é—®åœ°å€ (URL)</label>
            <input type="text" id="formUrl" placeholder="https://...">
        </div>
        <div class="form-group">
            <label>ç™»å½•è´¦å·</label>
            <input type="text" id="formUsername">
        </div>
        <div class="form-group">
            <label>ç™»å½•å¯†ç </label>
            <input type="text" id="formPassword">
        </div>
        <div class="modal-footer">
            <button onclick="closeModal()" style="border:none; background:#eee; padding:8px 15px; border-radius:8px; cursor:pointer">å–æ¶ˆ</button>
            <button onclick="saveAccount()" style="border:none; background:#2e7d32; color:white; padding:8px 15px; border-radius:8px; cursor:pointer">ä¿å­˜å¹¶åŒæ­¥</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
<div id="globalUrlTooltip" class="url-tooltip"></div>

<script>
    // åˆå§‹åŒ–çŸ¥æ™“äº‘ (è¯·åŠ¡å¿…æ£€æŸ¥ ClientID)
    // BaaS.init('YOUR_CLIENT_ID'); 

    let accountsData = [];

    // è·å–æ•°æ®
    async function fetchAccounts() {
        try {
            const table = new BaaS.Table('accounts');
            let res = await table.orderBy(['order', '-created_at']).limit(100).find();
            accountsData = res.data.objects;
            renderCards(accountsData);
        } catch (err) {
            console.error('è·å–å¤±è´¥:', err);
            // ç¦»çº¿æ¨¡å¼æˆ–åˆå§‹åŒ–æœªå®Œæˆæ—¶æ˜¾ç¤º Mock æ•°æ®
            if(accountsData.length === 0) {
                accountsData = [
                    { id:'1', system:'ç¤ºä¾‹ï¼šGithub', username:'user@git.com', password:'password123', url:'https://github.com', order:0 }
                ];
                renderCards(accountsData);
            }
        }
    }

    // æ¸²æŸ“å¡ç‰‡
    function renderCards(data) {
        const grid = document.getElementById('accountsGrid');
        grid.innerHTML = '';
        data.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'account-card';
            card.draggable = true;
            card.dataset.id = item.id;
            card.dataset.system = item.system;
            card.dataset.username = item.username;
            
            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            card.ondragstart = (e) => e.dataTransfer.setData('text/plain', item.id);
            card.ondragover = (e) => e.preventDefault();
            card.ondrop = onDrop;

            card.innerHTML = `
                <div class="system-name">${item.system}</div>
                ${item.url ? `
                    <div class="link-icon" onmouseenter="showTooltip(event, '${item.url}')" onmouseleave="hideTooltip()" onclick="window.open('${item.url}')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="%232e7d32"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                    </div>
                ` : ''}
                <div style="padding: 0 5px">
                    <div style="font-size:12px; color:#888">è´¦å·</div>
                    <div class="item-value" onclick="copyText('${item.username}')">${item.username}</div>
                    <div style="font-size:12px; color:#888; margin-top:8px">å¯†ç </div>
                    <div class="item-value" onclick="copyText('${item.password}')">${item.password}</div>
                </div>
                <div class="delete-btn" onclick="deleteAccount('${item.id}', event)" title="åˆ é™¤è´¦å·">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    // æœç´¢é«˜äº®é€»è¾‘
    function performSearch() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        const cards = document.querySelectorAll('.account-card');
        const clearBtn = document.getElementById('clearButton');
        
        clearBtn.style.display = query ? 'flex' : 'none';

        cards.forEach(card => {
            const sysElem = card.querySelector('.system-name');
            const valElems = card.querySelectorAll('.item-value');
            
            // åŸå§‹æ–‡æœ¬è¿˜åŸ
            const sysText = card.dataset.system;
            const userText = card.dataset.username;
            
            const hit = !query || sysText.toLowerCase().includes(query) || userText.toLowerCase().includes(query);
            
            card.classList.remove('hit', 'dim');
            if (query) {
                card.classList.add(hit ? 'hit' : 'dim');
                // é«˜äº®å¤„ç†
                if(hit) {
                    sysElem.innerHTML = highlight(sysText, query);
                    valElems[0].innerHTML = highlight(userText, query);
                }
            } else {
                sysElem.textContent = sysText;
                valElems[0].textContent = userText;
            }
        });
    }

    function highlight(text, key) {
        if (!key) return text;
        const reg = new RegExp(`(${key})`, 'gi');
        return text.replace(reg, '<span class="highlight">$1</span>');
    }

    // Tooltip è¾¹ç•Œé¿è®©ç®—æ³•
    function showTooltip(e, url) {
        const tip = document.getElementById('globalUrlTooltip');
        tip.textContent = url;
        tip.classList.add('show');
        
        const rect = e.currentTarget.getBoundingClientRect();
        const tipWidth = tip.offsetWidth || 200;
        
        let x = rect.left;
        let y = rect.bottom + 8;

        // è‡ªåŠ¨é¿è®©å³è¾¹ç¼˜
        if (x + tipWidth > window.innerWidth - 20) {
            x = window.innerWidth - tipWidth - 25;
        }
        // é¿å¼€å·¦è¾¹ç¼˜
        if (x < 10) x = 10;

        tip.style.left = x + 'px';
        tip.style.top = y + 'px';
    }

    function hideTooltip() {
        document.getElementById('globalUrlTooltip').classList.remove('show');
    }

    // ä¿å­˜é€»è¾‘ä¿®å¤
    async function saveAccount() {
        const system = document.getElementById('formSystem').value.trim();
        const url = document.getElementById('formUrl').value.trim();
        const username = document.getElementById('formUsername').value.trim();
        const password = document.getElementById('formPassword').value.trim();

        if(!system || !username) return showToast('ç³»ç»Ÿåå’Œè´¦å·ä¸èƒ½ä¸ºç©º', '#f44336');

        try {
            const table = new BaaS.Table('accounts');
            let record = table.create();
            await record.set({
                system, url, username, password,
                order: accountsData.length + 1
            }).save();
            
            showToast('æ•°æ®å·²å®‰å…¨ä¿å­˜è‡³äº‘ç«¯');
            closeModal();
            // æ¸…ç©ºè¡¨å•
            document.querySelectorAll('.modal-content input').forEach(i => i.value = '');
            // åˆ·æ–°ä¸»ç•Œé¢
            await fetchAccounts();
        } catch (err) {
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®', '#f44336');
        }
    }

    // æ‹–æ‹½æ’åºä¿å­˜
    async function onDrop(e) {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData('text/plain');
        const targetId = this.dataset.id;
        if (draggedId === targetId) return;

        // é‡æ–°ç»„ç»‡æœ¬åœ°æ•°æ®æ•°ç»„é¡ºåº
        const draggedIdx = accountsData.findIndex(a => a.id === draggedId);
        const targetIdx = accountsData.findIndex(a => a.id === targetId);
        const [removed] = accountsData.splice(draggedIdx, 1);
        accountsData.splice(targetIdx, 0, removed);

        renderCards(accountsData); // ç«‹å³æœ¬åœ°æ¸²æŸ“ï¼Œæå‡æ‰‹æ„Ÿ

        try {
            const table = new BaaS.Table('accounts');
            // æ‰¹é‡æ›´æ–°æ•°æ®åº“ order (çŸ¥æ™“äº‘å»ºè®®å¾ªç¯æ›´æ–°æˆ–ä½¿ç”¨æ‰¹é‡æ“ä½œæ¥å£)
            const updates = accountsData.map((item, index) => {
                return table.getWithoutData(item.id).update({ order: index });
            });
            await Promise.all(updates);
            showToast('æ’åºå·²ä¿å­˜');
        } catch (err) {
            showToast('æ’åºä¿å­˜å¤±è´¥', '#f44336');
            fetchAccounts(); // å¤±è´¥åˆ™å›æ»š
        }
    }

    async function deleteAccount(id, e) {
        e.stopPropagation();
        if(!confirm('ç¡®å®šåˆ é™¤è¯¥è´¦å·å—ï¼Ÿä¸å¯æ¢å¤')) return;
        try {
            const table = new BaaS.Table('accounts');
            await table.delete(id);
            showToast('å·²æˆåŠŸç§»é™¤');
            fetchAccounts();
        } catch (err) { showToast('åˆ é™¤å¤±è´¥'); }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => showToast('å·²æˆåŠŸå¤åˆ¶'));
    }

    function showToast(msg, bg = '#4caf50') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.background = bg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2500);
    }

    function openModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function updateTime() {
        const now = new Date();
        document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('zh-CN', {hour12:false});
        const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        document.getElementById('solarDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${w[now.getDay()]}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateTime();
        setInterval(updateTime, 1000);
        fetchAccounts();
        document.getElementById('searchInput').addEventListener('input', performSearch);
        document.getElementById('clearButton').onclick = () => {
            document.getElementById('searchInput').value = '';
            performSearch();
        };
    });
</script>
</body>
</html>
