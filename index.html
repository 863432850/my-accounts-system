<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·å¯†ç ç®¡ç†å™¨ V4.1 (ä¸“ä¸šäº‘åŒæ­¥ç‰ˆ)</title>
    <link rel="icon" href="images/book.png" type="image/x-icon">
    <script src="./mincloud.js"></script>
    <style>
        /* ===== åŸºç¡€æ ·å¼ä¸ V3 ä¿æŒé«˜åº¦ä¸€è‡´ ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 50%, #f0f4c3 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* ===== å¤´éƒ¨å¸ƒå±€ä¼˜åŒ–ï¼šæ–°å¢æŒ‰é’®é å·¦ä¸€ç‚¹ ===== */
        .header {
            display: grid;
            grid-template-columns: auto auto auto 1fr; /* æ–°å¢ä¸€åˆ— */
            align-items: center;
            margin-bottom: 30px;
            color: #2e7d32;
            gap: 20px;
        }
        .header h1 { font-size: 2.5rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .btn-add {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.2);
            white-space: nowrap;
        }
        .btn-add:hover { background: #388e3c; transform: translateY(-2px); }

        .time-search-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
        }

        /* ===== æœç´¢ä¸æ—¶é—´æ˜¾ç¤º ===== */
        .clock-container {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 15px;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .time-display { font-size: 1.6rem; font-weight: bold; font-family: 'Courier New', monospace; }
        .date-display { display: flex; align-items: center; gap: 15px; font-size: 0.9rem; color: #388e3c; }

        .search-container { position: relative; }
        .search-input {
            padding: 6px 35px;
            border: 2px solid #c8e6c9;
            border-radius: 10px;
            width: 200px;
            height: 37px;
            background: rgba(255, 255, 255, 0.9);
        }
        .clear-button {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: #ff6b6b; color: white; border: none; width: 18px; height: 18px;
            border-radius: 50%; cursor: pointer; display: none;
        }

        /* ===== æœç´¢é«˜äº®æ ·å¼ [æ”¹è¿›ç‚¹1] ===== */
        .highlight {
            background-color: #ffeb3b;
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
            font-weight: bold;
        }

        /* ===== è´¦å·å¡ç‰‡åŒºåŸŸ ===== */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }
        .account-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
            cursor: grab;
        }
        .account-card:active { cursor: grabbing; }
        .account-card.dim { opacity: 0.2; filter: grayscale(1); pointer-events: none; }
        .account-card.hit { box-shadow: 0 0 0 3px #4caf50; }

        .system-name {
            font-size: 1.1rem; font-weight: bold; color: #2e7d32;
            padding-bottom: 8px; border-bottom: 2px solid #c8e6c9;
            margin-bottom: 10px; padding-right: 60px;
        }

        .account-item { display: flex; align-items: center; margin-bottom: 8px; gap: 10px; }
        .item-label { font-size: 0.85rem; color: #4caf50; min-width: 40px; }
        .item-value {
            background: #f1f8e9; border: 2px solid #c8e6c9; border-radius: 8px;
            padding: 5px 10px; cursor: pointer; flex: 1; font-family: monospace;
            font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis;
        }

        /* ===== å›¾æ ‡å¢å¼º [æ”¹è¿›ç‚¹5] ===== */
        .action-icons { position: absolute; right: 10px; top: 12px; display: flex; gap: 8px; }
        .icon-btn { cursor: pointer; opacity: 0.6; transition: 0.2s; display: flex; align-items: center; }
        .icon-btn:hover { opacity: 1; transform: scale(1.2); }
        .delete-btn { color: #ff5252; }

        /* ===== Tooltip è¾¹ç•Œä¿®æ­£ [æ”¹è¿›ç‚¹2] ===== */
        .url-tooltip {
            position: fixed; background: #333; color: white; padding: 6px 12px;
            border-radius: 6px; font-size: 12px; z-index: 10000;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
            max-width: 300px; word-break: break-all;
        }
        .url-tooltip.show { opacity: 1; }

        /* ===== å¼¹çª—æ ·å¼ ===== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; justify-content: center; align-items: center; z-index: 20000;
        }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 380px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.85rem; margin-bottom: 4px; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #4caf50; color: white; padding: 10px 20px; border-radius: 20px;
            z-index: 30000; display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ” è´¦å·å¯†ç ç®¡ç†å™¨</h1>
        
        <button class="btn-add" onclick="openModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            æ–°å¢è´¦å·
        </button>

        <div class="time-search-container">
            <div class="clock-container">
                <div class="date-display">
                    <div class="time-display" id="timeDisplay">00:00:00</div>
                    <div id="solarDate">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ç³»ç»Ÿæˆ–è´¦å·...">
                <button class="clear-button" id="clearButton">âœ•</button>
            </div>
        </div>
    </div>

    <div class="accounts-grid" id="accountsGrid">
        </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <h3 style="margin-bottom:15px; color:#2e7d32">æ–°å¢/ç¼–è¾‘è´¦å·</h3>
        <div class="form-group"><label>ç³»ç»Ÿåç§°</label><input type="text" id="m_system"></div>
        <div class="form-group"><label>ç”¨æˆ·å</label><input type="text" id="m_user"></div>
        <div class="form-group"><label>å¯†ç </label><input type="text" id="m_pass"></div>
        <div class="form-group"><label>é“¾æ¥ (å¯é€‰)</label><input type="text" id="m_url"></div>
        <div class="modal-footer">
            <button onclick="closeModal()" style="padding:6px 12px; cursor:pointer">å–æ¶ˆ</button>
            <button onclick="saveAccount()" style="padding:6px 12px; background:#2e7d32; color:white; border:none; border-radius:4px; cursor:pointer">ä¿å­˜åˆ°äº‘ç«¯</button>
        </div>
    </div>
</div>

<div id="globalTooltip" class="url-tooltip"></div>
<div id="toast" class="toast"></div>

<script>
    // ===== é…ç½®åŒº [æ”¹è¿›ç‚¹ï¼šè§£å†³401æŠ¥é”™] =====
    const CLIENT_ID = 'beb23e269f45432272c6'; // è¯·ç¡®ä¿æ­¤å¤„IDæ­£ç¡®
    const TABLE_ID = 'account_list'; // ä½ çš„çŸ¥æ™“äº‘æ•°æ®è¡¨ID

    try {
        window.BaaS.init(CLIENT_ID);
    } catch(e) { console.error("BaaS Init Failed", e); }

    let allAccounts = [];

    // ===== 1. è·å–æ•°æ® =====
    async function fetchAccounts() {
        showToast("æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...");
        try {
            let table = new BaaS.TableObject(TABLE_ID);
            let res = await table.limit(1000).orderBy('-created_at').find();
            allAccounts = res.data.objects;
            renderCards(allAccounts);
        } catch (err) {
            console.error(err);
            if(err.status === 401) alert("èº«ä»½éªŒè¯å¤±è´¥(401)ï¼šè¯·æ£€æŸ¥çŸ¥æ™“äº‘ClientIDå’Œè¡¨æƒé™è®¾ç½®ï¼");
        }
    }

    // ===== 2. æ¸²æŸ“å¡ç‰‡ [æ”¹è¿›ç‚¹1ï¼šå¢åŠ æœç´¢é«˜äº®é€»è¾‘] =====
    function renderCards(dataList, query = "") {
        const grid = document.getElementById('accountsGrid');
        grid.innerHTML = '';
        
        dataList.forEach(item => {
            const card = document.createElement('div');
            card.className = 'account-card';
            card.draggable = true; // [æ”¹è¿›ç‚¹6ï¼šå¼€å¯æ‹–æ‹½]
            
            // å¤„ç†é«˜äº®
            const highlight = (text) => {
                if (!query) return text;
                const reg = new RegExp(`(${query})`, 'gi');
                return text.toString().replace(reg, '<span class="highlight">$1</span>');
            };

            card.innerHTML = `
                <div class="action-icons">
                    ${item.url ? `
                    <div class="icon-btn" onmouseenter="showUrl(event, '${item.url}')" onmouseleave="hideUrl()" onclick="window.open('${item.url}')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="#2e7d32"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                    </div>` : ''}
                    <div class="icon-btn delete-btn" onclick="deleteAccount('${item._id}')" title="åˆ é™¤">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </div>
                </div>
                <div class="system-name">${highlight(item.system)}</div>
                <div class="account-item">
                    <span class="item-label">è´¦å·</span>
                    <div class="item-value" onclick="copyText('${item.username}')">${highlight(item.username)}</div>
                </div>
                <div class="account-item">
                    <span class="item-label">å¯†ç </span>
                    <div class="item-value" onclick="copyText('${item.password}')">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</div>
                </div>
            `;
            
            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            bindDragEvents(card);
            grid.appendChild(card);
        });
    }

    // ===== 3. ä¿å­˜æ•°æ® [æ”¹è¿›ç‚¹4ï¼šä¿®å¤ä¿å­˜é€»è¾‘å¹¶åˆ·æ–°] =====
    async function saveAccount() {
        const data = {
            system: document.getElementById('m_system').value,
            username: document.getElementById('m_user').value,
            password: document.getElementById('m_pass').value,
            url: document.getElementById('m_url').value
        };
        if(!data.system || !data.username) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

        try {
            let table = new BaaS.TableObject(TABLE_ID);
            let entry = table.create();
            await entry.set(data).save();
            showToast("ä¿å­˜æˆåŠŸï¼å·²åŒæ­¥è‡³äº‘ç«¯");
            closeModal();
            fetchAccounts(); // åˆ·æ–°åˆ—è¡¨
        } catch (err) {
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æƒé™");
        }
    }

    // ===== 4. åˆ é™¤æ•°æ® [æ”¹è¿›ç‚¹5ï¼šå¢åŠ ç¡®è®¤] =====
    async function deleteAccount(id) {
        if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡äº‘ç«¯è®°å½•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ã€‚")) return;
        try {
            let table = new BaaS.TableObject(TABLE_ID);
            await table.delete(id);
            showToast("å·²ä»äº‘ç«¯åˆ é™¤");
            fetchAccounts();
        } catch (err) { alert("åˆ é™¤å¤±è´¥"); }
    }

    // ===== 5. Tooltip è¾¹ç•Œä¼˜åŒ– [æ”¹è¿›ç‚¹2] =====
    function showUrl(e, url) {
        const tip = document.getElementById('globalTooltip');
        tip.textContent = "è·³è½¬: " + url;
        tip.classList.add('show');
        
        let x = e.clientX + 10;
        let y = e.clientY + 10;
        
        // è‡ªåŠ¨é¿å¼€å±å¹•è¾¹ç¼˜
        if (x + 200 > window.innerWidth) x = window.innerWidth - 210;
        if (y + 50 > window.innerHeight) y = window.innerHeight - 60;
        
        tip.style.left = x + 'px';
        tip.style.top = y + 'px';
    }
    function hideUrl() { document.getElementById('globalTooltip').classList.remove('show'); }

    // ===== 6. æœç´¢åŠŸèƒ½ =====
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.getElementById('clearButton').style.display = query ? 'block' : 'none';
        
        const cards = document.querySelectorAll('.account-card');
        cards.forEach(card => {
            const text = card.innerText.toLowerCase();
            const isHit = text.includes(query);
            card.style.display = isHit ? 'block' : 'none';
        });
        // é‡æ–°æ¸²æŸ“ä»¥åº”ç”¨é«˜äº®ï¼ˆå¯é€‰ï¼Œæˆ–ç›´æ¥ç”¨CSSæ˜¾ç¤ºéšè—ï¼‰
        if(!query) renderCards(allAccounts);
    });

    document.getElementById('clearButton').onclick = () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('clearButton').style.display = 'none';
        renderCards(allAccounts);
    };

    // ===== 7. æ‹–æ‹½æ’åºé€»è¾‘ [æ”¹è¿›ç‚¹6] =====
    let draggedItem = null;
    function bindDragEvents(el) {
        el.addEventListener('dragstart', () => { draggedItem = el; setTimeout(() => el.style.opacity = '0.5', 0); });
        el.addEventListener('dragend', () => { el.style.opacity = '1'; draggedItem = null; });
        el.addEventListener('dragover', e => e.preventDefault());
        el.addEventListener('drop', function(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                const allCards = [...document.querySelectorAll('.account-card')];
                const curIdx = allCards.indexOf(this);
                const dragIdx = allCards.indexOf(draggedItem);
                if (curIdx > dragIdx) this.after(draggedItem);
                else this.before(draggedItem);
                showToast("é¡ºåºå·²è°ƒæ•´ï¼ˆä»…æœ¬åœ°ç”Ÿæ•ˆï¼‰");
            }
        });
    }

    // ===== è¾…åŠ©åŠŸèƒ½ =====
    function copyText(txt) {
        navigator.clipboard.writeText(txt).then(() => showToast("å·²æˆåŠŸå¤åˆ¶åˆ°å‰ªè´´æ¿"));
    }
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
    function openModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function updateTime() {
        const now = new Date();
        document.getElementById('timeDisplay').textContent = now.toLocaleTimeString('zh-CN', {hour12:false});
        const weeks = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
        document.getElementById('solarDate').textContent = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${weeks[now.getDay()]}`;
    }

    setInterval(updateTime, 1000);
    updateTime();
    fetchAccounts();
</script>

</body>
</html>

